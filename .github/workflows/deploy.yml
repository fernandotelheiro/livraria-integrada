name: CD - Deploy livraria integrada

on:
  release:
    types: [published]

# Variáveis globais (não sensíveis)
env:
  APP_NAME: ${{ vars.APP_NAME }}

jobs:
  build:
    name: Build para deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Dar permissão de execução ao gradlew
        run: chmod +x gradlew

      - name: Build sem testes (compila e empacota)
        run: ./gradlew clean build -x test

      - name: Publicar artefato para deploy
        uses: actions/upload-artifact@v4
        with:
          name: livraria-dist
          path: build/libs/**/*.jar

  deploy-dev:
    name: Deploy em ambiente DEV
    runs-on: ubuntu-latest
    needs: build
    environment: dev

    env:
      APP_ENV: dev
      BASE_URL: ${{ secrets.DEV_BASE_URL }}

    steps:
      - name: Baixar artefato gerado no build
        uses: actions/download-artifact@v4
        with:
          name: livraria-dist
          path: dist

      - name: Simular deploy em DEV
        run: |
          echo "Aplicação: $APP_NAME"
          echo "Ambiente: $APP_ENV"
          echo "Realizando deploy para URL: $BASE_URL"

  deploy-prod:
    name: Deploy em ambiente PROD
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: prod   # ambiente protegido

    env:
      APP_ENV: prod
      BASE_URL: ${{ secrets.PROD_BASE_URL }}
      DEPLOY_TOKEN: ${{ secrets.PROD_DEPLOY_TOKEN }}

    steps:
      - name: Baixar artefato gerado no build
        uses: actions/download-artifact@v4
        with:
          name: livraria-dist
          path: dist

      - name: Simular deploy em PROD
        run: |
          echo "Aplicação: $APP_NAME"
          echo "Ambiente: $APP_ENV"
          echo "Usando token de deploy (mascado): $DEPLOY_TOKEN"
          echo "Realizando deploy para URL: $BASE_URL"
