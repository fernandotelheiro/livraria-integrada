name: CD - Deploy livraria integrada

on:
  release:
    types: [published]

# Variáveis globais (não sensíveis)
env:
  APP_NAME: ${{ vars.APP_NAME }}

jobs:
  build:
    name: Build para deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Dar permissão de execução ao gradlew
        run: chmod +x gradlew

      - name: Build sem testes (compila e empacota)
        run: ./gradlew clean build -x test

      - name: Publicar artefato para deploy
        uses: actions/upload-artifact@v4
        with:
          name: livraria-dist
          path: build/libs/**/*.jar

  deploy_dev:
    name: Deploy em ambiente DEV
    runs-on: ubuntu-latest
    needs: build
    env:
      BASE_URL: ${{ secrets.DEV_BASE_URL }}
      APP_NAME: ${{ env.APP_NAME }}

    steps:
      - name: Baixar artefatos (JAR)
        uses: actions/download-artifact@v4
        with:
          name: livraria-dist

      - name: Simular deploy em DEV
        run: |
          echo "::notice::Iniciando deploy no ambiente DEV para a app $APP_NAME"
          echo "Usando base URL: $BASE_URL"
          # aqui iria o comando real de deploy para DEV

      - name: Resumo do deploy DEV
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
        run: |
          echo "## Deploy - Ambiente DEV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Status do job: **$JOB_STATUS**" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`$GITHUB_WORKFLOW\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release: \`$GITHUB_REF_NAME\`" >> $GITHUB_STEP_SUMMARY

  deploy_prod:
    name: Deploy em ambiente PROD
    runs-on: ubuntu-latest
    needs: deploy_dev
    # Se você quiser usar proteção de ambiente, crie um ambiente "production" no GitHub
    # e descomente a linha abaixo:
    # environment: production
    env:
      BASE_URL: ${{ secrets.PROD_BASE_URL }}
      DEPLOY_TOKEN: ${{ secrets.PROD_DEPLOY_TOKEN }}
      APP_NAME: ${{ env.APP_NAME }}

    steps:
      - name: Baixar artefatos (JAR)
        uses: actions/download-artifact@v4
        with:
          name: livraria-dist

      - name: Simular deploy em PROD
        run: |
          echo "::warning::Iniciando deploy no ambiente PROD para a app $APP_NAME"
          echo "Usando base URL: $BASE_URL"
          echo "Chamando endpoint de deploy com token mascarado"
          # Exemplo de chamada (comentado para não falhar):
          # curl -X POST "$BASE_URL/deploy" \
          #   -H "Authorization: Bearer $DEPLOY_TOKEN" || true

      - name: Resumo do deploy PROD
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
        run: |
          echo "## Deploy - Ambiente PROD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Status do job: **$JOB_STATUS**" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`$GITHUB_WORKFLOW\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release: \`$GITHUB_REF_NAME\`" >> $GITHUB_STEP_SUMMARY
